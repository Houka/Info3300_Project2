<html>
<head>
	<title>INFO 3300 - Project 2 (cl795, jsm398, mrm343)</title>
	<link rel="icon" type="image/x-icon" href="favicon.ico" />
	<link href="https://fonts.googleapis.com/css?family=Montserrat" rel="stylesheet">
  	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
	<script src="https://d3js.org/d3.v4.min.js"></script>
	<script src="https://d3js.org/topojson.v2.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/d3-legend/2.21.0/d3-legend.min.js"></script>
	<style>
        .background {
		  fill: none;
		  pointer-events: all;
		}

		.feature {
		  stroke: black;
		  cursor: pointer;
		  stroke-width: .2;
		}

		.feature.active {
		  fill: orange;
		}
		.mesh {
		  fill: none;
		  stroke: black;
		  stroke-width: .05;
		}
		#svg_world {
			float: left;
		  	border: solid white 1px;
		  	margin-top: 20px;
		}
		#svg_side {
			background: white;
			float: right;
			position: absolute;
			left: 780px;
			margin-top: 20px;
		  	border: solid white 1px;
		}


    </style>
</head>
<body>
	<div id="header" class="jumbotron text-center">
		<h1>Pollution and Politics</h1>
	</div>
	<div id="sliderDiv" class="container text-center">
		<b><span id="yearLabel">Year: 1960</span></b>
		<input type="range" id="yearSlider" max="1960" min="2016" value="1960" />
		<span class="pull-left">1960</span>
		<span class="pull-right">2016</span>
	</div>
	<div id="main" class="container-fluid text-center" style="background-color: #ccc;">
	</div>
	

	<!-- javascripts imported at the end -->
	<script src = "js/LineGraph.js"></script>
	<script src = "js/Sunburst.js"></script>
	<script src = "js/Scatterplot.js"></script>
	<script src = "js/Map.js"></script>
	<script src = "js/DataLoader.js"></script>
	<script> // setup global variables script
		var debug = true;
		var mainDiv = d3.select("#main");

		//Initialize side-view
		var svg_side = d3.select("#main").append("svg")
			.attr("id", "svg_side")
			.attr("width", 400)
			.attr("height", 500)

		var country_name = svg_side.append("text")	
			.attr("font-size", 20)
			.attr("x", 200)
			.attr("y", 30)
			.attr("text-anchor", "middle")
			.attr("fill", "#aaa")
			.html("Country Name");

		// svg_side.append("text")
		// 	.attr("font-size", 17)
		// 	.attr("x", 30)
		// 	.attr("y", 100)
		// 	.attr("fill", "#aaa")
		// 	.html("Pollution Level: ");

		// svg_side.append("text")
		// 	.attr("font-size", 17)
		// 	.attr("x", 30)
		// 	.attr("y", 150)
		// 	.attr("fill", "#aaa")
		// 	.html("Democratic Scale: ");

		//Initialize map 
		var width = 750;
		var height = 500;
		var active = d3.select(null);

		var projection = d3.geoMercator().scale(100).translate([370,270]);;

		var zoom = d3.zoom()
			.scaleExtent([1,8])
			.on("zoom", zoomed);

		var path = d3.geoPath().projection(projection);

		var svg_world = d3.select("#main").append("svg")
			.attr("id", "svg_world")
			.attr("width", width)
			.attr("height", height)
			.on("click", stopped, true)

		svg_world.append("rect")
	    	.attr("class", "background")
		    .attr("width", width)
		    .attr("height", height)
		    .on("click", reset);

		var world_g = svg_world.append("g").attr("id", "world_g");
		svg_world
				.call(zoom);

		//Set up country names
		var country_names = [];

		d3.tsv("world-110m-country-names.tsv", function(error, tsv){
				if (error) throw error;
				
				tsv.forEach(function(d,i) {
					country_names[d.id] = d.name;
				})
		})

		//Display map 
		d3.json("world-110m.json", function (error, data) {
			if (error) throw error;

			world_g.selectAll("path")
				.data(topojson.feature(data, data.objects.countries).features)
				.enter().append("path")
				.attr("d", path)
				.attr("class", "feature")
				.attr("fill", function(a, b) {/*console.log(country_names[a.id]);*/ return "white";})
				.on("click", clicked);

				world_g.append("path")
				.datum(topojson.mesh(data, data.objects.countries, function(a, b) { return a !== b; }))
				.attr("class", "mesh")
				.attr("d", path);

		})

		function clicked(d) {

		  country_name.html(country_names[d.id]);
		  country = country_names[d.id];
		  //displayLineGraph([], year, svg_side);
		  //displaySunburst([], year, svg_side);

		  if (active.node() === this) return reset();
		  active.classed("active", false);
		  active = d3.select(this).classed("active", true);

		  var bounds = path.bounds(d),
		      dx = bounds[1][0] - bounds[0][0],
		      dy = bounds[1][1] - bounds[0][1],
		      x = (bounds[0][0] + bounds[1][0]) / 2,
		      y = (bounds[0][1] + bounds[1][1]) / 2,
		      scale = Math.max(1, Math.min(8, 0.9 / Math.max(dx / width, dy / height))),
		      translate = [width / 2 - scale * x, height / 2 - scale * y];

		  svg_world.transition()
		      .duration(750)
		      .call( zoom.transform, d3.zoomIdentity.translate(translate[0],translate[1]).scale(scale) );
		}

		function reset() {
		  active.classed("active", false);
		  active = d3.select(null);
		  svg_side.select("g").remove();
		  country_name.html("Country Name");
		  svg_world.transition()
		      .duration(750)
		      .call( zoom.transform, d3.zoomIdentity );
		}

		function zoomed() {
		  world_g.style("stroke-width", 1.5 / d3.event.transform.k + "px");
		  world_g.attr("transform", d3.event.transform); 
		}

		// If the drag behavior prevents the default click,
		// also stop propagation so we donâ€™t click-to-zoom.
		function stopped() {
		  if (d3.event.defaultPrevented) d3.event.stopPropagation();
		}


		// screen resolution
		var widthScale = 1500/window.innerWidth;
		var screenHeight = 600 / widthScale;
		var screenWidth = 1500 / widthScale;
		var footerOffset = 50;
		// set main div to screen resolution
		mainDiv
			.style("height", "540")
			.style("width", "100%");

		// updating vars
		var WAIT_TIME = 100; // in milliseconds


		// year variables
		var year = 0;
		var prevYear = 0;
		var country = "";
		var prevCountry = "";
		var MIN_YEAR = 1960;
		var MAX_YEAR = 2016;
		var years = d3.range(MAX_YEAR-MIN_YEAR).map(function(i){return i+MIN_YEAR});
		var yearSlider = d3.select("#yearSlider");

		// setting year variables
		yearSlider.property("min", MIN_YEAR);
		yearSlider.property("max", MAX_YEAR);
		year = yearSlider.property("value");
		yearSlider.on("change", function(){
			year = yearSlider.property("value");
			d3.select("#yearLabel").text("Year: "+year);
			log("year changed to: " + year);
		});

		// debug logging function wrapper
		function log(msg){
			if (debug)
				console.log(msg);
		}
	</script>
	<script> // get, filter, and display data
		// var main = mainDiv.append("svg").attr("width",700).attr("height",400);
		// var bottom = mainDiv.append("svg").attr("width",700).attr("height",400);
		// var debug = d3.select("body").append("svg").attr("width",500).attr("height",500);
		/** Updates the display graphics on screen given a year and the data */
		function update(data){
			log("in update()");

			// main displaying code goes 
			displayLineGraph(data, year, svg_side, "USA");
			// displaySunburst(data, year, side1);
			// displayScatterplot(data, year, bottom);
			// displayMap(data, year, main);

			// put the update function in a interval that updates every 1500 milliseconds
			d3.interval(function() {
				// only update if there was a change in the input for year
				if (prevYear != year){
					update(data);
					prevYear = year;
					log("prev year: "+prevYear+", year:"+year);
				}
				if (country != prevCountry){
					update(data);
					prevCountry = country;
				}
			}, WAIT_TIME);
		}

		function displayData(){
			log("in displayData()");
			// Load the csv data files and then runs a callback to display the data
			loadData(function(data) {
				update(data);
			});
		}

		log("starting up... debug = "+debug);
		displayData();
	</script>

</body>
</html>
